/*
 * transmitter
 *
 *  Created on: Sep 5, 2023
 *  Author: Abdelrahman Hamdy
 */

#include "Func_main.h"

u8 CheckPassword(u8 L_Bool);

u8 CheckID();

u16 GetNumber();

u8 G_WrongTrial=0;

int main(){

	//u16 Password,ID;
	u8 Bool1=0, Bool2=0;
	HLCD_VoidInit();
	MUART_VoidInit();
	HKPD_VoidInit();

while(1){

	if (HKPD_u8GetPressedKey()=='*' || HKPD_u8GetPressedKey()=='#')
	{
		MUART_VoidTransmit('C');
		for(u8 i =0 ; i<3;i++)
		{
		Bool1=CheckID();
		if (Bool1 != 0)
		{	break;	}
		G_WrongTrial++;
		}
		if(Bool1 != 0)
		{
			G_WrongTrial=0;
			for(u8 i =0 ; i<3;i++)
			{
				Bool2=CheckPassword(Bool1);
				if (Bool2 != 0)
					{	break;	}
			G_WrongTrial++;
			}
		}
//		else
//		{		G_WrongTrial++;					}

		switch(Bool2)
		{
		case 1:
			HLCD_VoidClear();
			HLCD_VoidSendString("Welcome");
			HLCD_VoidCursor(0,LINE1);
			HLCD_VoidSendString("Amr");
			MUART_VoidTransmit('M');

			_delay_ms(1500);

			HLCD_VoidClear();
			HLCD_VoidSendString("Please wait for");
			HLCD_VoidCursor(0,LINE1);
			HLCD_VoidSendString("admin approval");

			while ( MUART_u8Receive() != 'P');

			HLCD_VoidClear();
			HLCD_VoidSendString("You can pass now");


			break;
		case 2:
			HLCD_VoidClear();
			HLCD_VoidSendString("Welcome");
			HLCD_VoidCursor(0,LINE1);
			HLCD_VoidSendString("Abdelrahman");
			MUART_VoidTransmit('B');

			_delay_ms(1500);

			HLCD_VoidClear();
			HLCD_VoidSendString("Please wait for");
			HLCD_VoidCursor(0,LINE1);
			HLCD_VoidSendString("admin approval");

			while ( MUART_u8Receive() != 'P');

			HLCD_VoidClear();
			HLCD_VoidSendString("You can pass now");
			break;
		case 3:
			HLCD_VoidClear();
			HLCD_VoidSendString("Welcome");
			HLCD_VoidCursor(0,LINE1);
			HLCD_VoidSendString("Wael");
			MUART_VoidTransmit('W');

			_delay_ms(1500);

			HLCD_VoidClear();
			HLCD_VoidSendString("Please wait for");
			HLCD_VoidCursor(0,LINE1);
			HLCD_VoidSendString("admin approval");

			while ( MUART_u8Receive() != 'P');

			HLCD_VoidClear();
			HLCD_VoidSendString("You can pass now");
			break;
		}
		if (G_WrongTrial == 3 || Bool1 ==0 ||Bool2 ==0)
		{
			HLCD_VoidClear();
			HLCD_VoidCursor(0,LINE0);
			HLCD_VoidSendString("Access denied");
			HLCD_VoidCursor(0,LINE1);
			HLCD_VoidSendString("Wait for admin");
			MUART_VoidTransmit('D');
			while ( MUART_u8Receive() != 'A');
		}
	}
}
return 0;
}



u16 GetNumber()
{
	u16 L_Number=0;
	u8 L_PressedKey=0;

	L_PressedKey=HKPD_u8GetPressedKey();
	while(L_PressedKey == '*' || L_PressedKey == '#' )
	{
		L_PressedKey=HKPD_u8GetPressedKey();
	}
	HLCD_VoidSendData(L_PressedKey);
	L_Number = (L_PressedKey-'0')*1000;


	L_PressedKey=HKPD_u8GetPressedKey();
	while(L_PressedKey == '*' || L_PressedKey == '#' )
	{
		L_PressedKey=HKPD_u8GetPressedKey();
	}
	HLCD_VoidSendData(L_PressedKey);
	L_Number += ((L_PressedKey-'0')*100);

	L_PressedKey=HKPD_u8GetPressedKey();
	while(L_PressedKey == '*' || L_PressedKey == '#' )
	{
		L_PressedKey=HKPD_u8GetPressedKey();
	}
	HLCD_VoidSendData(L_PressedKey);
	L_Number += ((L_PressedKey-'0')*10);


	L_PressedKey=HKPD_u8GetPressedKey();
	while(L_PressedKey == '*' || L_PressedKey == '#' )
	{
		L_PressedKey=HKPD_u8GetPressedKey();
	}
	HLCD_VoidSendData(L_PressedKey);
	L_Number += (L_PressedKey-'0');

	return L_Number;
}

u8 CheckID()
{
	u16 L_ID, id1=1234, id2=5678, id3=7891;

	HLCD_VoidClear();
	HLCD_VoidSendString("Please enter ID:");
	HLCD_VoidCursor(0,LINE1);
	L_ID=GetNumber();

	if		( L_ID==id1 )	{	return 1;	}
	else if	( L_ID==id2 )	{	return 2;	}
	else if ( L_ID==id3 )	{	return 3;	}
	else
	{
		_delay_ms(500);
		HLCD_VoidClear();
		HLCD_VoidSendString("Wrong ID");
		_delay_ms(1500);

		return 0;
	}

}
u8 CheckPassword( u8 A_Bool )
{
	u16 pass1=4321 /* Ahmed  */	,
		pass2=8765 /*  Nour  */	,
		pass3=1987 /* Khaled */ ;

	u16 L_Pass;

	HLCD_VoidClear();
	HLCD_VoidSendString("Enter Password:");
	HLCD_VoidCursor(0,LINE1);
	L_Pass=GetNumber();

	if		(A_Bool == 1 && L_Pass==pass1 )	{	return 1;	}
	else if	(A_Bool == 2 && L_Pass==pass2 )	{	return 2;	}
	else if (A_Bool == 3 && L_Pass==pass3 )	{	return 3;	}
	else
	{
		HLCD_VoidClear();
		HLCD_VoidSendString("Wrong password");

		_delay_ms(1000);

		return 0;
	}


}
